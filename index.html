<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALLã¤ãªã BRIDGE - å¤šç›®çš„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ–</title>

    <!-- Icons & Manifest -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%236366F1'/%3E%3Cpath d='M50 70 L70 70 L80 50 L100 50 L110 70 L130 70 L130 130 L50 130 Z' fill='none' stroke='white' stroke-width='12' stroke-linejoin='round'/%3E%3Ccircle cx='90' cy='100' r='20' stroke='white' stroke-width='8' fill='none'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%236366F1'/%3E%3Cpath d='M50 70 L70 70 L80 50 L100 50 L110 70 L130 70 L130 130 L50 130 Z' fill='none' stroke='white' stroke-width='12' stroke-linejoin='round'/%3E%3Ccircle cx='90' cy='100' r='20' stroke='white' stroke-width='8' fill='none'/%3E%3C/svg%3E">
    <link rel="manifest" type="application/manifest+json"
        href="data:application/manifest+json;base64,eyJuYW1lIjoiQUxMã¤ãªã BRIDGEIiwic2hvcnRfbmFtZSI6IkJSSURHRSIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGZhZmMiLCJ0aGVtZV9jb2xvciI6IiM2MzY2ZjEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxODAgMTgwJyUzRSUzQ3JlY3Qgd2lkdGg9JzE4MCcgaGVpZ2h0PScxODAnIHJ4PSc0MCcgZmlsbD0nJTIzNjM2NkYxJy8lM0UlM0NwYXRoIGQ9J001MCA3MCBMNzAgNzAgTDgwIDUwIEwxMDAgNTAgTDExMCA3MCBMMTMwIDcwIExzMTMwIDEzMCBMNTAgMTMwIFonIGZpbGw9J25vbmUnIHN0cm9rZT0nd2hpdGUnIHN0cm9rZS13aWR0aD0nMTInIHN0cm9rZS1saW5lam9pbj0ncm91bmQnLzUzRSUzQ2NpcmNsZSBjeD0nOTAnIGN5PScxMDAnIHI9JzIwJyBzdHJva2U9J3doaXRlJyBzdHJva2Utd2lkdGg9JzhmIGZpbGw9J25vbmUnLzUzRSUzQy9zdmclMjIsc2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJwdXJwb3NlIjoiYW55In1dfQ==">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for Browser JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap');
        
        body {
            font-family: 'BIZ UDGothic', sans-serif;
            background-color: #f8fafc;
        }

        .font-ud { font-family: 'BIZ UDGothic', sans-serif; }

        /* Smooth transitions for tab switching */
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: all 300ms ease-out; }

        /* Corporate terminal look for photo metadata */
        .terminal-overlay {
            color: #00FF41;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- UTILS: SHARE & DATA CONVERSION ---
        const dataURLtoFile = (dataurl, filename) => {
            const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--) u8arr[n] = bstr.charCodeAt(n);
            return new File([u8arr], filename, {type:mime});
        };

        const shareContent = async (text, files = []) => {
            const fallback = () => {
                window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
            };

            try {
                const canShareFiles = files && files.length > 0 && navigator.canShare && navigator.canShare({ files });
                
                // å…±æœ‰å‡¦ç†ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
                const sharePromise = (async () => {
                    if (canShareFiles) {
                        await navigator.share({ files, title: 'BRIDGE' });
                    } else if (navigator.share) {
                        await navigator.share({ text });
                    } else {
                        throw new Error('Web Share API Not Found');
                    }
                })();

                // 2ç§’ä»¥ä¸Šåå¿œãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000));
                await Promise.race([sharePromise, timeoutPromise]);

            } catch (err) {
                // AbortError(ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒ³ã‚»ãƒ«)ä»¥å¤–ã¯LINEã¸é£›ã°ã™
                if (err.name !== 'AbortError') {
                    fallback();
                }
            }
        };

        // --- LUCIDE ICONS WRAPPER ---
        const Icons = {
            Home: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            ),
            Briefcase: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
            ),
            Smile: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
            ),
            Send: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            ),
            Image: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
            ),
            Camera: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
            ),
            Zap: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            ),
            Command: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/></svg>
            )
        };

        /* ==========================================================================
           UI: FAMILY PANEL
           ========================================================================== */
        const FamilyPanel = () => {
            const [draft, setDraft] = useState({ message: '', mood: 'happy', mediaFiles: [] });
            const [previewUrl, setPreviewUrl] = useState(null);
            const [processedFile, setProcessedFile] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    setPreviewUrl(URL.createObjectURL(file));
                    setDraft({...draft, mediaFiles: [file]});
                }
            };

            const simulateSend = async () => {
                if(!draft.message && draft.mediaFiles.length === 0) return;
                setIsGenerating(true);
                try {
                    let file;
                    if (draft.message || draft.mood) {
                        const dataUrl = await FamilyEngine.generateMessageCard(draft.message, draft.mood, draft.mediaFiles[0]);
                        file = dataURLtoFile(dataUrl, `family_${Date.now()}.jpg`);
                    } else {
                        file = draft.mediaFiles[0];
                    }

                    const moodText = draft.mood ? (draft.mood === 'happy' ? 'ğŸ˜Š æ¥½ã—ã„' : draft.mood === 'calm' ? 'ğŸ˜Œ ã¾ã£ãŸã‚Š' : 'ğŸ¤© ã‚ãã‚ã') : '';
                    await shareContent(`ã€å®¶æ—é€£çµ¡ã€‘ ${moodText}`, file ? [file] : []);
                } catch (err) {
                    console.error("Share failed:", err);
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-pink-100 max-w-2xl mx-auto transition-all">
                    <div className="bg-gradient-to-r from-pink-400 to-rose-300 p-6 text-white">
                        <h2 className="text-2xl font-bold flex items-center gap-2">
                            <Icons.Home className="w-6 h-6" /> å®¶æ—æ²ç¤ºæ¿
                        </h2>
                        <p className="text-sm opacity-90 mt-1">å¤§åˆ‡ãªå®¶æ—ã¸ã€ä»Šã®æ°—æŒã¡ã‚’å±Šã‘ã¾ã™ã€‚</p>
                    </div>
                    <div className="p-6 space-y-6">
                        <div className="flex gap-2">
                            {['none', 'happy', 'calm', 'excited'].map(mood => (
                                <button key={mood} onClick={() => setDraft({...draft, mood: mood === 'none' ? null : mood})} 
                                    className={`flex-1 py-3 rounded-xl font-bold transition-all text-[10px] md:text-sm ${((mood === 'none' && !draft.mood) || draft.mood === mood) ? 'bg-pink-500 text-white shadow-lg' : 'bg-gray-100 text-gray-500'}`}>
                                    {mood === 'none' ? 'ğŸ˜¶ ãªã—' : mood === 'happy' ? 'ğŸ˜Š æ¥½ã—ã„' : mood === 'calm' ? 'ğŸ˜Œ ã¾ã£ãŸã‚Š' : 'ğŸ¤© ã‚ãã‚ã'}
                                </button>
                            ))}
                        </div>
                        <textarea className="w-full p-4 bg-pink-50 rounded-2xl h-32 focus:ring-2 focus:ring-pink-300 outline-none text-gray-700 font-bold"
                            placeholder="ä»Šæ—¥ã®ã”ã¯ã‚“ã¯ä½•ã‹ãªï¼Ÿ / ä»Šã‹ã‚‰å¸°ã‚‹ã‚ˆï¼" value={draft.message} onChange={e => setDraft({...draft, message: e.target.value})} />
                        <div className="flex items-center gap-4">
                            <label className="flex-grow">
                                <div className="w-full py-4 bg-white border-2 border-dashed border-gray-300 rounded-2xl flex items-center justify-center gap-2 cursor-pointer hover:bg-gray-50">
                                    <Icons.Image className="w-5 h-5 text-gray-400" />
                                    <span className="text-gray-500 font-bold">å†™çœŸã‚’æ·»ä»˜</span>
                                </div>
                                <input type="file" className="hidden" accept="image/*" onChange={handleFileChange} />
                            </label>
                            {previewUrl && <img src={previewUrl} className="w-16 h-16 rounded-lg object-cover border-2 border-pink-200" />}
                        </div>
                        <button onClick={simulateSend} disabled={isGenerating || (!draft.message && !draft.mood && draft.mediaFiles.length === 0)}
                            className={`w-full py-4 ${isGenerating ? 'bg-gray-400' : 'bg-pink-500 hover:bg-pink-600'} text-white rounded-2xl font-bold shadow-lg transition-all flex items-center justify-center gap-2`}>
                            {isGenerating ? 'æº–å‚™ä¸­...' : <React.Fragment><Icons.Send className="w-5 h-5" /> LINEã§ã¿ã‚“ãªã«é€ã‚‹</React.Fragment>}
                        </button>
                    </div>
                </div>
            );
        };

        /* ==========================================================================
           LOGIC: CORPORATE ENGINE (æ¥­å‹™ç”¨å ±å‘Š)
           ========================================================================== */
        class CorporateEngine {
            static async processEvidencePhoto(file, meta) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width; canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            const barHeight = Math.max(img.height * 0.12, 60);
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                            ctx.fillRect(0, img.height - barHeight, img.width, barHeight);

                            const fontSize = Math.max(img.height * 0.03, 18);
                            ctx.font = `bold ${fontSize}px sans-serif`;
                            ctx.fillStyle = '#00FF41'; 
                            
                            const date = meta.time || new Date();
                            const dateStr = `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
                            const locStr = `LAT:${meta.lat.toFixed(5)} LNG:${meta.lng.toFixed(5)}`;
                            const speedStr = `${meta.speed} km/h`;

                            ctx.fillText(dateStr, 20, img.height - (barHeight * 0.65));
                            ctx.fillText(locStr, 20, img.height - (barHeight * 0.3));
                            ctx.textAlign = 'right';
                            ctx.fillText(speedStr, img.width - 20, img.height - (barHeight / 2));

                            ctx.strokeStyle = 'rgba(255, 50, 50, 0.8)';
                            ctx.lineWidth = Math.max(img.width * 0.01, 5);
                            ctx.strokeRect(0, 0, canvas.width, canvas.height);

                            resolve(canvas.toDataURL('image/jpeg', 0.9));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        /* ==========================================================================
           UI: CORPORATE PANEL
           ========================================================================== */
        const CorporatePanel = () => {
            const [draft, setDraft] = useState({ title: '', description: '', urgency: 'medium', location: 'æ±äº¬éƒ½...' });
            const [isProcessing, setIsProcessing] = useState(false);
            const [processedUrl, setProcessedUrl] = useState(null);
            const [processedFile, setProcessedFile] = useState(null);
            const [fileType, setFileType] = useState('image'); // 'image' | 'video'
            const [gps, setGps] = useState({ lat: 35.6812, lng: 139.7671, speed: 0 });

            useEffect(() => {
                const watchId = navigator.geolocation.watchPosition(
                    (pos) => setGps({ lat: pos.coords.latitude, lng: pos.coords.longitude, speed: Math.floor(pos.coords.speed || 0) * 3.6 }),
                    (err) => console.error(err),
                    { enableHighAccuracy: true }
                );
                return () => navigator.geolocation.clearWatch(watchId);
            }, []);

            const handlePhoto = async (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    setIsProcessing(true);
                    try {
                        if (file.type.startsWith('image/')) {
                            setFileType('image');
                            const url = await CorporateEngine.processEvidencePhoto(file, { ...gps, time: new Date() });
                            setProcessedUrl(url);
                            setProcessedFile(dataURLtoFile(url, "report_" + Date.now() + ".jpg"));
                        } else if (file.type.startsWith('video/')) {
                            setFileType('video');
                            const url = URL.createObjectURL(file);
                            setProcessedUrl(url);
                            setProcessedFile(file);
                        }
                    } catch (err) {
                        console.error(err);
                    } finally {
                        setIsProcessing(false);
                    }
                }
            };

            const sendReport = () => {
                if(!draft.title) return;
                const urgencyEmoji = draft.urgency === 'high' ? 'ğŸš¨ã€è‡³æ€¥ã€‘' : draft.urgency === 'medium' ? 'âš ï¸ã€æ³¨æ„ã€‘' : 'âœ…ã€é€šå¸¸ã€‘';
                const date = new Date();
                const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                const mediaNote = fileType === 'image' 
                    ? `â€»è¨¼æ‹ ç”»åƒå†…ã«ãƒ‡ãƒ¼ã‚¿ç„¼ãè¾¼ã¿æ¸ˆã¿ã€‚`
                    : `â€»ã€å‹•ç”»è¨¼æ‹ ã€‘ç™ºç”Ÿåœ°ç‚¹: LAT ${gps.lat.toFixed(5)}, LNG ${gps.lng.toFixed(5)}, é€Ÿåº¦: ${gps.speed} km/h`;

                const text = `${urgencyEmoji} ç¾å ´å ±å‘Š\n` +
                    `------------------\n` +
                    `ä»¶å: ${draft.title}\n` +
                    `å†…å®¹: ${draft.description}\n` +
                    `å ´æ‰€: ${draft.location}\n` +
                    `æ™‚åˆ»: ${timeStr}\n` +
                    `é€Ÿåº¦: ${gps.speed} km/h\n` +
                    `------------------\n` +
                    `${mediaNote}`;
                
                shareContent(text, processedFile ? [processedFile] : []);
            };

            return (
                <div className="bg-slate-800 rounded-3xl shadow-2xl overflow-hidden border-4 border-slate-700 max-w-2xl mx-auto text-slate-100 transition-all">
                    <div className="bg-slate-900 p-6 flex justify-between items-center border-b border-slate-700">
                        <div>
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <Icons.Briefcase className="w-6 h-6 text-blue-400" /> ç¾å ´å ±å‘Šã‚·ã‚¹ãƒ†ãƒ 
                            </h2>
                            <p className="text-[10px] text-slate-400 uppercase tracking-widest mt-1">Status: SECURE GEOLOCATION ENGINE</p>
                        </div>
                    </div>
                    <div className="p-6 space-y-4">
                        <select className="w-full bg-slate-700 p-3 rounded-xl border border-slate-600 outline-none focus:ring-2 focus:ring-blue-500 text-white"
                            value={draft.urgency} onChange={e => setDraft({...draft, urgency: e.target.value})}>
                            <option value="low">é€šå¸¸å ±å‘Š (Normal)</option>
                            <option value="medium">æ³¨æ„å–šèµ· (Caution)</option>
                            <option value="high">è‡³æ€¥å ±å‘Š (Priority)</option>
                        </select>
                        <input className="w-full bg-slate-700 p-3 rounded-xl border border-slate-600 outline-none font-bold" 
                            placeholder="å ±å‘Šä»¶å (ä¾‹: é“è·¯æ··é›‘ã€ç´å“å®Œäº†)" value={draft.title} onChange={e => setDraft({...draft, title: e.target.value})} />
                        <textarea className="w-full bg-slate-700 p-3 rounded-xl border border-slate-600 h-24 font-bold" 
                            placeholder="çŠ¶æ³è©³ç´°ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„..." value={draft.description} onChange={e => setDraft({...draft, description: e.target.value})} />
                        
                        <div className="grid grid-cols-2 gap-4">
                            <label className="cursor-pointer">
                                <div className="h-40 bg-slate-900 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed border-slate-600 hover:border-blue-500 transition-all">
                                    {isProcessing ? (
                                        <div className="animate-spin text-blue-400 font-bold">...</div>
                                    ) : (
                                        <div className="flex gap-2">
                                            <Icons.Camera className="w-10 h-10 text-slate-500" />
                                            <div className="w-px h-10 bg-slate-700"></div>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-500"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>
                                        </div>
                                    )}
                                    <span className="text-xs text-slate-400 mt-2 font-bold uppercase">è¨¼æ‹ å†™çœŸãƒ»å‹•ç”»ã‚’æ’®å½±</span>
                                </div>
                                <input type="file" className="hidden" accept="image/*,video/*" capture="environment" onChange={handlePhoto} />
                            </label>
                            <div className="h-40 bg-black rounded-2xl overflow-hidden shadow-inner border border-slate-700 relative">
                                {processedUrl ? (
                                    fileType === 'image' ? (
                                        <img src={processedUrl} className="w-full h-full object-cover" />
                                    ) : (
                                        <video src={processedUrl} className="w-full h-full object-cover" controls />
                                    )
                                ) : (
                                    <div className="flex items-center justify-center h-full text-[10px] text-slate-600 font-bold uppercase">PREVIEW / DATA</div>
                                )}
                            </div>
                        </div>

                        <button onClick={sendReport} disabled={!processedUrl || !draft.title}
                            className={`w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all shadow-xl ${draft.urgency === 'high' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'} disabled:opacity-50`}>
                            <Icons.Zap className="w-5 h-5" /> æœ¬éƒ¨ã¸é€ä¿¡ ({fileType === 'image' ? 'è¨¼æ‹ ç„¼ãè¾¼ã¿æ¸ˆ' : 'ãƒ‡ãƒ¼ã‚¿æ–‡é¢è¨˜è¼‰'})
                        </button>
                    </div>
                </div>
            );
        };

        /* ==========================================================================
           LOGIC: FAMILY ENGINE (å®¶æ—é€£çµ¡)
           ========================================================================== */
        class FamilyEngine {
            static async generateMessageCard(message, mood, originalFile) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 800; canvas.height = 800;

                    const drawBody = (img = null) => {
                        try {
                            const grad = ctx.createLinearGradient(0, 0, 0, 800);
                            grad.addColorStop(0, '#FFF5F7'); grad.addColorStop(1, '#FFE4E8');
                            ctx.fillStyle = grad; ctx.fillRect(0, 0, 800, 800);

                            if (img) {
                                const size = 500;
                                const tx = 150, ty = 80;
                                let sw, sh, sx, sy;
                                const ratio = img.width / img.height;
                                if (ratio > 1) { sh = img.height; sw = img.height; sx = (img.width - img.height) / 2; sy = 0; }
                                else { sw = img.width; sh = img.width; sx = 0; sy = (img.height - img.width) / 2; }
                                
                                ctx.save();
                                // roundRect ã®ä»£ã‚ã‚Šã«å››è§’å½¢ã§æç”»ï¼ˆäº’æ›æ€§é‡è¦–ï¼‰
                                ctx.beginPath();
                                ctx.rect(tx, ty, size, size);
                                ctx.clip();
                                ctx.drawImage(img, sx, sy, sw, sh, tx, ty, size, size);
                                ctx.restore();
                            }
                            
                            if (mood) {
                                ctx.fillStyle = '#E11D48';
                                ctx.font = 'bold 60px sans-serif';
                                ctx.textAlign = 'center';
                                const moodIcon = mood === 'happy' ? 'ğŸ˜Š æ¥½ã—ã„' : mood === 'calm' ? 'ğŸ˜Œ ã¾ã£ãŸã‚Š' : 'ğŸ¤© ã‚ãã‚ã';
                                ctx.fillText(moodIcon, 400, img ? 650 : 350);
                            }

                            if (message) {
                                ctx.fillStyle = '#334155'; ctx.font = 'bold 40px sans-serif'; ctx.textAlign = 'center';
                                const wrapText = (t, x, y, mw, lh) => {
                                    const words = t.split(''); let line = '';
                                    for(let n = 0; n < words.length; n++) {
                                        let test = line + words[n];
                                        if (ctx.measureText(test).width > mw && n > 0) { ctx.fillText(line, x, y); line = words[n]; y += lh; }
                                        else line = test;
                                    }
                                    ctx.fillText(line, x, y);
                                };
                                wrapText(message, 400, img ? 720 : (mood ? 450 : 400), 700, 50);
                            }
                            resolve(canvas.toDataURL('image/jpeg', 0.9));
                        } catch (e) { reject(e); }
                    };

                    if (originalFile) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => drawBody(img);
                            img.onerror = () => reject(new Error("Image Load Error"));
                            img.src = e.target.result;
                        };
                        reader.onerror = () => reject(new Error("File Read Error"));
                        reader.readAsDataURL(originalFile);
                    } else { drawBody(); }
                });
            }
        }

        /* ==========================================================================
           LOGIC: FRIENDS ENGINE (å‹äººãƒ»éŠã³)
           ========================================================================== */
        class FriendsEngine {
            static async applyPopFilter(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const size = Math.min(img.width, img.height);
                            canvas.width = canvas.height = size;
                            ctx.filter = 'saturate(1.5) contrast(1.1) brightness(1.05)';
                            ctx.drawImage(img, (img.width-size)/2, (img.height-size)/2, size, size, 0, 0, size, size);
                            
                            const fw = size * 0.04;
                            ctx.strokeStyle = '#ffffff'; ctx.lineWidth = fw * 2;
                            ctx.strokeRect(0, 0, size, size);
                            
                            const d = new Date();
                            const ds = `${d.getMonth()+1}.${d.getDate()}`;
                            ctx.font = `bold ${size * 0.12}px sans-serif`;
                            ctx.fillStyle = '#ffffff';
                            ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 10;
                            ctx.fillText(ds, size * 0.08, size * 0.92);
                            
                            resolve(canvas.toDataURL('image/jpeg', 0.8));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        /* ==========================================================================
           UI: FRIENDS PANEL
           ========================================================================== */
        const FriendsPanel = () => {
            const [draft, setDraft] = useState({ title: '', budget: '', type: 'drink' });
            const [preview, setPreview] = useState(null);
            const [processedFile, setProcessedFile] = useState(null);

            const handlePhoto = async (e) => {
                if(e.target.files[0]) {
                    const file = e.target.files[0];
                    const url = await FriendsEngine.applyPopFilter(file);
                    setPreview(url);
                    setProcessedFile(dataURLtoFile(url, `party_${Date.now()}.jpg`));
                }
            };

            const share = () => {
                if(!draft.title) return;
                const typeIcon = draft.type === 'drink' ? 'ğŸ» é£²ã¿ä¼š' : draft.type === 'trip' ? 'âœˆï¸ æ—…è¡Œ' : 'ğŸ® ã‚²ãƒ¼ãƒ ';
                const text = `ã€éŠã³ã®è¨ˆç”»ã€‘${typeIcon}\n` +
                    `ã‚¤ãƒ™ãƒ³ãƒˆ: ${draft.title}\n` +
                    `äºˆç®—ç›®å®‰: ${draft.budget}å††\n\n` +
                    `ä¸€ç·’ã«ã©ã†ï¼ŸğŸ–ï¸`;
                
                shareContent(text, processedFile ? [processedFile] : []);
            };

            return (
                <div className="bg-white rounded-[3rem] shadow-2xl overflow-hidden border-[10px] border-cyan-50 max-w-2xl mx-auto transition-all">
                    <div className="bg-cyan-400 p-8 text-white relative overflow-hidden">
                        <div className="absolute -right-8 -top-8 bg-cyan-300 w-32 h-32 rounded-full opacity-50"></div>
                        <h2 className="text-3xl font-black italic flex items-center gap-3 relative z-10">
                            <Icons.Smile className="w-8 h-8 fill-white" /> éŠã³ãƒ»è¨ˆç”»
                        </h2>
                        <p className="text-xs font-bold tracking-tighter uppercase mt-1 relative z-10">Next Event Planning Hub</p>
                    </div>
                    <div className="p-8 space-y-6">
                        <div className="grid grid-cols-3 gap-2">
                             {['drink', 'trip', 'game'].map(t => (
                                 <button key={t} onClick={() => setDraft({...draft, type: t})}
                                    className={`py-4 rounded-3xl flex flex-col items-center border-[3px] transition-all transform hover:scale-105 ${draft.type === t ? 'border-cyan-400 bg-cyan-50 scale-105' : 'border-gray-100 bg-gray-50 text-gray-400'}`}>
                                    <span className="text-3xl">{t === 'drink' ? 'ğŸ»' : t === 'trip' ? 'âœˆï¸' : 'ğŸ®'}</span>
                                    <span className="text-[10px] font-black mt-1 uppercase tracking-widest">{t}</span>
                                 </button>
                             ))}
                        </div>
                        <div className="space-y-4">
                            <div className="relative">
                                <span className="absolute left-6 top-1/2 -translate-y-1/2 text-cyan-400 font-black text-xl">#</span>
                                <input className="w-full bg-gray-50 pl-12 p-5 rounded-3xl outline-none border-2 border-transparent focus:border-cyan-200 font-bold text-lg"
                                    placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå" value={draft.title} onChange={e => setDraft({...draft, title: e.target.value})} />
                            </div>
                            <div className="relative">
                                <span className="absolute left-6 top-1/2 -translate-y-1/2 text-cyan-400 font-black text-xl">Â¥</span>
                                <input className="w-full bg-gray-50 pl-12 p-5 rounded-3xl outline-none border-2 border-transparent focus:border-cyan-200 font-mono text-lg font-bold"
                                    placeholder="äºˆç®—ç›®å®‰ (ã²ã¨ã‚Š)" value={draft.budget} onChange={e => setDraft({...draft, budget: e.target.value})} />
                            </div>
                        </div>

                        <div className="flex gap-4">
                             <label className="flex-1">
                                <div className="h-48 bg-gray-50 rounded-[2rem] border-4 border-dashed border-gray-200 flex flex-col items-center justify-center hover:bg-cyan-50 hover:border-cyan-200 transition-all cursor-pointer">
                                    <Icons.Camera className="w-12 h-12 text-gray-300" />
                                    <p className="text-[10px] font-black text-gray-400 mt-2 uppercase tracking-widest">Add Party Photo</p>
                                </div>
                                <input type="file" className="hidden" accept="image/*" onChange={handlePhoto} />
                             </label>
                             {preview && (
                                <div className="flex-1 rounded-[2rem] overflow-hidden shadow-2xl border-8 border-white transform rotate-3 hover:rotate-0 transition-transform duration-500">
                                    <img src={preview} className="w-full h-full object-cover" />
                                </div>
                             )}
                        </div>

                        <button onClick={share} disabled={!draft.title}
                            className="w-full py-6 bg-black text-white rounded-[2rem] font-black text-2xl hover:scale-105 active:scale-95 transition-all shadow-2xl flex items-center justify-center gap-3 disabled:opacity-30">
                            <Icons.Send className="w-8 h-8" /> SHARE!
                        </button>
                    </div>
                </div>
            );
        };

        /* ==========================================================================
           MAIN APP: ALLã¤ãªã BRIDGE
           ========================================================================== */
        const App = () => {
            const [mode, setMode] = useState('family'); // 'family' | 'corporate' | 'friends'

            return (
                <div className="min-h-screen flex flex-col font-ud transition-colors duration-700">
                    <nav className="bg-white border-b border-gray-100 sticky top-0 z-50 shadow-sm backdrop-blur-md bg-white/90">
                        <div className="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className={`p-3 rounded-2xl transition-all duration-500 ${mode === 'family' ? 'bg-pink-100 rotate-0' : mode === 'corporate' ? 'bg-slate-800 rotate-90' : 'bg-cyan-100 -rotate-12'}`}>
                                    <Icons.Command className={`w-8 h-8 ${mode === 'family' ? 'text-pink-500' : mode === 'corporate' ? 'text-white' : 'text-cyan-500'}`} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-black tracking-tighter text-gray-800">ALLã¤ãªã BRIDGE</h1>
                                    <p className="text-[10px] font-bold text-gray-400 uppercase leading-none tracking-widest">Connectivity Hub</p>
                                </div>
                            </div>
                            
                            <div className="hidden md:flex bg-gray-100 p-1.5 rounded-2xl gap-1">
                                <button onClick={() => setMode('family')} className={`px-8 py-2.5 rounded-xl text-sm font-black transition-all ${mode === 'family' ? 'bg-white text-pink-600 shadow-lg' : 'text-gray-400 hover:text-gray-600'}`}>å®¶æ—</button>
                                <button onClick={() => setMode('corporate')} className={`px-8 py-2.5 rounded-xl text-sm font-black transition-all ${mode === 'corporate' ? 'bg-slate-800 text-white shadow-lg' : 'text-gray-400 hover:text-gray-600'}`}>æ¥­å‹™ç”¨</button>
                                <button onClick={() => setMode('friends')} className={`px-8 py-2.5 rounded-xl text-sm font-black transition-all ${mode === 'friends' ? 'bg-white text-cyan-600 shadow-lg' : 'text-gray-400 hover:text-gray-600'}`}>å‹äºº</button>
                            </div>
                        </div>
                    </nav>

                    <main className={`flex-grow p-6 md:p-12 transition-colors duration-1000 ${mode === 'family' ? 'bg-[#FFF5F7]' : mode === 'corporate' ? 'bg-slate-900' : 'bg-[#F0FDFF]'}`}>
                        <div className="max-w-4xl mx-auto">
                            <div className="mb-12 text-center transform transition-all">
                                <h3 className={`text-4xl md:text-6xl font-black tracking-tighter mb-4 ${mode === 'corporate' ? 'text-white' : 'text-gray-900'}`}>
                                    {mode === 'family' ? 'Home Sweet Home' : mode === 'corporate' ? 'Business Reporting' : 'Party & Planning'}
                                </h3>
                                <p className={`text-lg font-bold italic ${mode === 'corporate' ? 'text-slate-500' : mode === 'family' ? 'text-pink-400' : 'text-cyan-500'}`}>
                                    {mode === 'family' ? 'ä»Šæ—¥ã®æ„Ÿè¬ã¨æ„›ã‚’ã€ã„ã¤ã‚‚ã®å®¶æ—ãƒãƒ£ãƒƒãƒˆã¸ã€‚' : mode === 'corporate' ? 'ç¢ºå®Ÿãªè¨¼æ‹ ã¨æ­£ç¢ºãªæƒ…å ±ã€‚ä¸€ç§’ã§ã‚‚æ—©ãå¸ä»¤å¡”ã¸ã€‚' : 'æœ€é«˜ã«ãƒãƒƒãƒ—ãªæ€ã„å‡ºã€‚é›†ã¾ã‚Šã®è¨ˆç”»ã‚’ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ã€‚'}
                                </p>
                            </div>

                            <div className="transition-all duration-500">
                                {mode === 'family' && <FamilyPanel />}
                                {mode === 'corporate' && <CorporatePanel />}
                                {mode === 'friends' && <FriendsPanel />}
                            </div>
                        </div>
                    </main>

                    <div className="md:hidden fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] bg-white/90 backdrop-blur-2xl border border-white/50 shadow-[0_20px_50px_rgba(0,0,0,0.2)] rounded-[2.5rem] p-2 flex gap-1 z-50">
                        <button onClick={() => setMode('family')} className={`flex-1 py-4 rounded-[2rem] flex flex-col items-center gap-1 transition-all ${mode === 'family' ? 'bg-pink-500 text-white shadow-lg' : 'text-gray-400'}`}>
                            <Icons.Home className="w-5 h-5" />
                            <span className="text-[10px] font-black mt-1">å®¶æ—</span>
                        </button>
                        <button onClick={() => setMode('corporate')} className={`flex-1 py-4 rounded-[2rem] flex flex-col items-center gap-1 transition-all ${mode === 'corporate' ? 'bg-slate-800 text-white shadow-lg' : 'text-gray-400'}`}>
                            <Icons.Briefcase className="w-5 h-5" />
                            <span className="text-[10px] font-black mt-1">æ¥­å‹™</span>
                        </button>
                        <button onClick={() => setMode('friends')} className={`flex-1 py-4 rounded-[2rem] flex flex-col items-center gap-1 transition-all ${mode === 'friends' ? 'bg-cyan-500 text-white shadow-lg' : 'text-gray-400'}`}>
                            <Icons.Smile className="w-5 h-5" />
                            <span className="text-[10px] font-black mt-1">å‹äºº</span>
                        </button>
                    </div>

                    <footer className={`py-10 text-center border-t transition-colors ${mode === 'corporate' ? 'bg-slate-900 border-slate-800 text-slate-600' : 'bg-white/50 border-gray-100 text-gray-400'}`}>
                         <p className="text-[10px] font-mono tracking-[0.3em] uppercase font-bold">ALL ã¤ãªã BRIDGE v2.1 | POWERED BY MUSUBI SYSTEM</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

